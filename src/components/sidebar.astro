---
import Announcement from "@components/sidebar/announcement.astro";
import Categories from "@components/sidebar/categories.astro";

import Profile from "@components/sidebar/profile.astro";
import Tags from "@components/sidebar/tags.astro";
import TOC from "@components/sidebar/toc.astro";
import { widgetManager } from "@utils/widget";
import type { MarkdownHeading } from "astro";

// å¼•å…¥ä½ çš„è‡ªå®šä¹‰ç»„ä»¶
import Statistics from "./sidebar/statistics.astro";
import VisitorInfo from "./sidebar/VisitorInfo.svelte";

interface Props {
	id?: string;
	class?: string;
	headings?: MarkdownHeading[];
	side: "left" | "right" | "middle";
}

const { id, class: className, headings, side } = Astro.props;

// è¿‡æ»¤æ‰é…ç½®é‡Œçš„ statisticsï¼Œé˜²æ­¢é‡å¤
const topComponents = widgetManager
	.getComponentsBySideAndPosition(side, "top")
	.filter((c) => c.type !== "statistics");
const stickyComponents = widgetManager
	.getComponentsBySideAndPosition(side, "sticky")
	.filter((c) => c.type !== "statistics");

const componentMap = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	toc: TOC,
};

function renderComponent(component: any, index: number) {
	const ComponentToRender =
		componentMap[component.type as keyof typeof componentMap];
	if (!ComponentToRender) return null;
	const componentClass = widgetManager.getComponentClass(
		component,
		index,
		side,
	);
	const componentStyle = widgetManager.getComponentStyle(component, index);
	return {
		Component: ComponentToRender,
		props: {
			class: componentClass,
			style: componentStyle,
			headings: component.type === "toc" ? headings : undefined,
			...component.customProps,
		},
	};
}
---

<div id={id || "sidebar"} data-side={side} class:list={[className, "w-full h-full"]}>
    
    {side === "left" && (
        <>
            {/* 1. é¡¶éƒ¨å›ºå®šç»„ä»¶ (å¦‚ Profile) */}
            {topComponents.length > 0 && (
                <div class:list={["flex flex-col w-full gap-4", { "mb-4": stickyComponents.length > 0 }]}>
                    {topComponents.map((component, index) => {
                        const renderData = renderComponent(component, index);
                        if (!renderData) return null;
                        const { Component, props } = renderData;
                        return <Component {...props} side={side} />;
                    })}
                </div>
            )}
            {/* 2. ç²˜æ€§ç»„ä»¶ (å¦‚ Tags) */}
            {stickyComponents.length > 0 && (
                <div id="sidebar-sticky" class="flex flex-col w-full gap-4 sticky top-4">
                    {stickyComponents.map((component, index) => {
                        const renderData = renderComponent(component, index);
                        if (!renderData) return null;
                        const { Component, props } = renderData;
                        return <Component {...props} side={side} />;
                    })}
                </div>
            )}
        </>
    )}

{side === "right" && (
        <>
            {/* ğŸ“¦ ç²˜æ€§å®¹å™¨å¼€å§‹ï¼šåŒ…å« ç›®å½•ã€ç»Ÿè®¡ã€è®¿å®¢ */}
            <div id="sidebar-sticky" class="flex flex-col w-full gap-4 sticky top-4 mb-4">
                
                {/* 1. ç›®å½• TOC (å¦‚æœæœ‰) */}
                {stickyComponents.length > 0 && (
                    stickyComponents.map((component, index) => {
                        const renderData = renderComponent(component, index);
                        if (!renderData) return null;
                        const { Component, props } = renderData;
                        return <Component {...props} side={side} />;
                    })
                )}

                {/* 2. è‡ªå®šä¹‰ç»Ÿè®¡æ¨¡å— */}
                <Statistics class="onload-animation" style="animation-delay: 0ms" />
                
                {/* 3. è®¿å®¢ä¿¡æ¯æ¨¡å— */}
                <VisitorInfo client:visible className="onload-animation" style="animation-delay: 100ms" />
            
            </div>
            {/* ğŸ“¦ ç²˜æ€§å®¹å™¨ç»“æŸ */}

            {/* 4. å…¶ä»–æ™®é€šç»„ä»¶ (å¦‚æœæœ‰ï¼Œä¼šæ˜¾ç¤ºåœ¨ç²˜æ€§æ¨¡å—ä¸‹æ–¹ï¼Œéšé¡µé¢æ»šåŠ¨æ¶ˆå¤±) */}
            {topComponents.length > 0 && (
                <div class="flex flex-col w-full gap-4">
                    {topComponents.map((component, index) => {
                        const renderData = renderComponent(component, index);
                        if (!renderData) return null;
                        const { Component, props } = renderData;
                        return <Component {...props} side={side} />;
                    })}
                </div>
            )}
        </>
    )}

    {side === "middle" && (
         <div class="flex flex-col w-full gap-4">
             {/* ä¸­é—´æ é€»è¾‘é€šå¸¸æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ¸²æŸ“å³å¯ */}
             {topComponents.map((component, index) => {
                const renderData = renderComponent(component, index);
                if (!renderData) return null;
                const { Component, props } = renderData;
                return <Component {...props} side={side} />;
            })}
         </div>
    )}

</div>