---
import Announcement from "@components/sidebar/announcement.astro";
import Categories from "@components/sidebar/categories.astro";
import Profile from "@components/sidebar/profile.astro";
import Tags from "@components/sidebar/tags.astro";
import TOC from "@components/sidebar/toc.astro";
import { widgetManager } from "@utils/widget";
import type { MarkdownHeading } from "astro";

// å¼•å…¥ä½ çš„è‡ªå®šä¹‰ç»„ä»¶
import Statistics from "./sidebar/statistics.astro";
import VisitorInfo from "./sidebar/VisitorInfo.svelte";

interface Props {
    id?: string;
    class?: string;
    headings?: MarkdownHeading[];
    side: "left" | "right" | "middle";
}

const { id, class: className, headings, side } = Astro.props;

// 1. è·å–é…ç½®ä¸­çš„ç»„ä»¶ï¼Œä½†è¿‡æ»¤æ‰ statistics å’Œ visitorinfo
// (å› ä¸ºæˆ‘ä»¬è¦æ‰‹åŠ¨æ§åˆ¶å®ƒä»¬çš„ä½ç½®ï¼Œé¿å…é…ç½®å’Œç¡¬ç¼–é‡å¤)
const topComponents = widgetManager
    .getComponentsBySideAndPosition(side, "top")
    .filter((c) => c.type !== "statistics" && c.type !== "visitorinfo");
    
const stickyComponents = widgetManager
    .getComponentsBySideAndPosition(side, "sticky")
    .filter((c) => c.type !== "statistics" && c.type !== "visitorinfo");

const componentMap = {
    profile: Profile,
    announcement: Announcement,
    categories: Categories,
    tags: Tags,
    toc: TOC,
    // statistics å’Œ visitorinfo åœ¨è¿™é‡Œä¸éœ€è¦æ˜ å°„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸‹é¢æ‰‹åŠ¨æ¸²æŸ“
};

function renderComponent(component: any, index: number) {
    const ComponentToRender =
        componentMap[component.type as keyof typeof componentMap];
    if (!ComponentToRender) return null;
    
    const componentClass = widgetManager.getComponentClass(
        component,
        index,
        side,
    );
    const componentStyle = widgetManager.getComponentStyle(component, index);

    return {
        Component: ComponentToRender,
        props: {
            class: componentClass,
            style: componentStyle,
            headings: component.type === "toc" ? headings : undefined,
            ...component.customProps,
        },
    };
}
---

<div id={id || "sidebar"} class:list={[className, "w-full h-full"]}>
    
    {/* ========================================= */}
    {/* åœºæ™¯ A: å·¦ä¾§è¾¹æ  (Left Sidebar)           */}
    {/* é€‚ç”¨è®¾å¤‡: ç”µè„‘ (XL) å’Œ å¹³æ¿ (LG)          */}
    {/* ========================================= */}
    {side === "left" && (
        <div class="flex flex-col w-full gap-4">
            {/* 1. æ¸²æŸ“é…ç½®çš„ Top ç»„ä»¶ (Profile, Announcement) */}
            {topComponents.map((component, index) => {
                const renderData = renderComponent(component, index);
                if (!renderData) return null;
                const { Component, props } = renderData;
                return <Component {...props} side={side} />;
            })}

            {/* 2. æ¸²æŸ“é…ç½®çš„ Sticky ç»„ä»¶ (Categories, Tags) */}
            <div class="sticky top-4 flex flex-col w-full gap-4">
                {stickyComponents.map((component, index) => {
                    const renderData = renderComponent(component, index);
                    if (!renderData) return null;
                    const { Component, props } = renderData;
                    return <Component {...props} side={side} />;
                })}

                {/* æ ¸å¿ƒä¼˜åŒ–ï¼šå¹³æ¿æ¨¡å¼ä¸‹çš„è¡¥å……æ˜¾ç¤º
                   åŸç†ï¼šå½“å±å¹• < LG æ—¶ï¼Œå³ä¾§æ ä¼šè¢« CSS éšè—ã€‚
                   æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å·¦ä¾§æ åº•éƒ¨æ˜¾ç¤ºè¿™ä¸¤ä¸ªç»„ä»¶ã€‚
                   ä½†å½“å±å¹• >= LG æ—¶ï¼Œå³ä¾§æ ä¼šå‡ºç°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨ lg:hidden éšè—å·¦è¾¹çš„è¿™ä»½ï¼Œé˜²æ­¢é‡å¤ã€‚
                */}
                <div class="flex flex-col gap-4 lg:hidden">
                    <Statistics class="onload-animation" style="animation-delay: 0ms" />
                    <VisitorInfo client:visible className="onload-animation" style="animation-delay: 100ms" />
                </div>
            </div>
        </div>
    )}


    {/* ========================================= */}
    {/* åœºæ™¯ B: å³ä¾§è¾¹æ  (Right Sidebar)          */}
    {/* é€‚ç”¨è®¾å¤‡: ä»…ç”µè„‘ (lg ä»¥ä¸Š)                */}
    {/* ========================================= */}
    {side === "right" && (
        <div class="flex flex-col w-full gap-4 h-full">
             {/* å³æ é€šå¸¸æ²¡æœ‰ Top ç»„ä»¶ï¼Œä½†ä¸ºäº†å…¼å®¹æ€§ä¿ç•™æ¸²æŸ“é€»è¾‘ */}
            {topComponents.map((component, index) => {
                const renderData = renderComponent(component, index);
                if (!renderData) return null;
                const { Component, props } = renderData;
                return <Component {...props} side={side} />;
            })}
            {/* Sticky åŒºåŸŸï¼šåŒ…å« TOCã€ç»Ÿè®¡ã€è®¿å®¢ */}
            <div class="sticky top-4 flex flex-col w-full gap-4">
                {/* 1. å…ˆæ¸²æŸ“ TOC (æ–‡ç« ç›®å½•) */}
                {stickyComponents.map((component, index) => {
                    const renderData = renderComponent(component, index);
                    if (!renderData) return null;
                    const { Component, props } = renderData;
                    return <Component {...props} side={side} />;
                })}

                {/* 2. ç«™ç‚¹ç»Ÿè®¡ (å§‹ç»ˆæ˜¾ç¤º) */}
                <Statistics class="onload-animation" style="animation-delay: 0ms" />
                
                {/* 3. è®¿å®¢ä¿¡æ¯ (å§‹ç»ˆæ˜¾ç¤º) */}
                <VisitorInfo client:visible className="onload-animation" style="animation-delay: 100ms" />
            </div>
        </div>
    )}


    {/* ========================================= */}
    {/* åœºæ™¯ C: ä¸­é—´/åº•éƒ¨æ  (Middle Sidebar)      */}
    {/* é€‚ç”¨è®¾å¤‡: æ‰‹æœº (Mobile)                   */}
    {/* ========================================= */}
    {side === "middle" && (
         <div class="flex flex-col w-full gap-4">
             {/* 1. æ¸²æŸ“é…ç½®çš„ç»„ä»¶ (Profile, Announcement) */}
             {topComponents.map((component, index) => {
                const renderData = renderComponent(component, index);
                if (!renderData) return null;
                const { Component, props } = renderData;
                return <Component {...props} side={side} />;
            })}
            
            {/* ğŸŸ¢ æ ¸å¿ƒä¼˜åŒ–ï¼šæ‰‹æœºç«¯è¡¥å……æ˜¾ç¤º 
                æ‰‹æœºç«¯æ²¡æœ‰ Sticky æ¦‚å¿µï¼Œæ‰€æœ‰å†…å®¹éƒ½æ˜¯ä»ä¸Šåˆ°ä¸‹æµå¼æ’åˆ—ã€‚
                æˆ‘ä»¬ç›´æ¥æŠŠç»Ÿè®¡å’Œè®¿å®¢åŠ åœ¨æœ€åå³å¯ã€‚
            */}
            <Statistics class="onload-animation" style="animation-delay: 0ms" />
            <VisitorInfo client:visible className="onload-animation" style="animation-delay: 100ms" />
         </div>
    )}
</div>
