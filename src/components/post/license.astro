---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { formatDateToYYYYMMDD } from "@utils/date";
import { Icon } from "astro-icon/components";
import { postConfig, profileConfig } from "@/config";

interface Props {
	title: string;
	id: string;
	pubDate: Date;
	class: string;
	author: string;
	sourceLink: string;
	licenseName: string;
	licenseUrl: string;
}

const { title, pubDate, author, sourceLink, licenseName, licenseUrl } =
	Astro.props;
const className = Astro.props.class;
const profileConf = profileConfig;
const licenseConf = postConfig.license;
const postUrl = sourceLink || decodeURIComponent(Astro.url.toString());
---

<div class={`relative transition overflow-hidden bg-[var(--license-block-bg)] py-5 px-6 ${className}`}>
    <div class="transition font-bold text-black/75 dark:text-white/75">
        {title}
    </div>
    
    <div class="flex items-center gap-2 mt-1">
        <a href={postUrl} class="link text-[var(--primary)] truncate">
            {postUrl}
        </a>
        <button
            id="copy-link-btn"
            class="group flex items-center justify-center w-6 h-6 rounded-md hover:bg-[var(--primary)]/10 transition-colors cursor-pointer"
            aria-label="Copy Link"
            data-url={postUrl}
        >
            <Icon 
                name="material-symbols:content-copy-outline" 
                class="copy-icon text-[1.2rem] text-black/50 dark:text-white/50 group-hover:text-[var(--primary)] transition-colors" 
            />
            <Icon 
                name="material-symbols:check-small-rounded" 
                class="success-icon text-[1.5rem] text-[var(--primary)] hidden" 
            />
        </button>
    </div>
    <div class="flex gap-6 mt-2">
        <div>
            <div class="transition text-black/30 dark:text-white/30 text-sm">作者</div>
            <div class="transition text-black/75 dark:text-white/75 line-clamp-2">{author || profileConf.name}</div>
        </div>
        <div>
            <div class="transition text-black/30 dark:text-white/30 text-sm">发布时间</div>
            <div class="transition text-black/75 dark:text-white/75 line-clamp-2">{formatDateToYYYYMMDD(pubDate)}</div>
        </div>
        <div>
            <div class="transition text-black/30 dark:text-white/30 text-sm">许可协议</div>
            <a href={licenseName ? (licenseUrl || undefined) : licenseConf.url} target="_blank" class="link text-[var(--primary)] line-clamp-2">{licenseName || licenseConf.name}</a>
        </div>
    </div>
    <Icon name="fa6-brands:creative-commons" class="transition text-[15rem] absolute pointer-events-none right-6 top-1/2 -translate-y-1/2 text-black/5 dark:text-white/5"></Icon>
</div>

<script>
    function initCopyButton() {
        const copyBtn = document.getElementById('copy-link-btn');
        if (!copyBtn) return;

        // 防止重复绑定事件 (Astro 页面切换时可能触发)
        const newBtn = copyBtn.cloneNode(true) as HTMLElement;
        copyBtn.parentNode?.replaceChild(newBtn, copyBtn);

        newBtn.addEventListener('click', async () => {
            const url = newBtn.getAttribute('data-url');
            if (!url) return;

            try {
                await navigator.clipboard.writeText(url);

                // 获取图标元素
                const copyIcon = newBtn.querySelector('.copy-icon');
                const successIcon = newBtn.querySelector('.success-icon');

                if (copyIcon && successIcon) {
                    // 切换显示状态
                    copyIcon.classList.add('hidden');
                    successIcon.classList.remove('hidden');

                    // 2秒后恢复原状
                    setTimeout(() => {
                        copyIcon.classList.remove('hidden');
                        successIcon.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        });
    }

    // 初始化
    initCopyButton();

    // 兼容 Astro View Transitions (如果后续开启了页面无刷新切换)
    document.addEventListener('astro:page-load', initCopyButton);
</script>