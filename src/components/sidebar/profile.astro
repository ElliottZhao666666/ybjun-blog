---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { url } from "@utils/url";
import { Icon } from "astro-icon/components";
import ImageWrapper from "@/components/common/imageWrapper.astro";
import { profileConfig, umamiConfig } from "@/config";

// è§£æ umami
const umamiEnabled = umamiConfig.enabled || false;
const umamiWebsiteId =
    umamiConfig.scripts.match(/data-website-id="([^"]+)"/)?.[1] || "";
const umamiApiKey = umamiConfig.apiKey || "";
const umamiBaseUrl = umamiConfig.baseUrl || "";

interface Props {
    class?: string;
    style?: string;
    side?: string;
}
const { class: className, style, side = "default" } = Astro.props;
const id = `profile-${side}`;
---

<div id={id} data-swup-persist={id} class="card-base p-3">
    <a aria-label="Go to About Page" href={url('/about/')}
       class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-48 lg:max-w-none overflow-hidden rounded-xl active:scale-95">
        <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center">
            <Icon name="fa6-regular:address-card"
                  class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl">
            </Icon>
        </div>
        <ImageWrapper src={profileConfig.avatar || ""} alt="Profile Image of the Author" class="mx-auto lg:w-full h-full lg:mt-0" loading="eager"></ImageWrapper>
    </a>
    <div class="px-2">
        <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition">{profileConfig.name}</div>
        <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2 transition"></div>
        <div class="text-center text-neutral-400 mb-2.5 transition">{profileConfig.bio}</div>
        
        <div class="flex gap-2 justify-center mb-1">
            {profileConfig.links.map(item => {
                // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ äº†å¯¹ url === '#wechat-qrcode' çš„åˆ¤æ–­
                // æ— è®ºä½ çš„ name æˆ– icon å†™æˆä»€ä¹ˆï¼Œåªè¦ url æ˜¯è¿™ä¸ªï¼Œå°±è®¤ä¸ºæ˜¯å¾®ä¿¡è§¦å‘å™¨
                const isWechat = item.url === '#wechat-qrcode' || 
                                 item.name.toLowerCase().includes('wechat') || 
                                 item.name === 'å…¬ä¼—å·' || 
                                 item.icon.includes('wechat');
                return (
                    <a 
                        rel="me" 
                        aria-label={item.name} 
                        /*å¦‚æœæ˜¯å¾®ä¿¡ï¼Œhref è®¾ä¸º javascript:void(0) é˜²æ­¢è·³è½¬*/
                        href={isWechat ? "javascript:void(0)" : item.url} 
                        /*å¦‚æœæ˜¯å¾®ä¿¡ï¼Œtarget è®¾ä¸º self*/
                        target={isWechat ? "_self" : "_blank"} 
                        /*å¦‚æœæ˜¯å¾®ä¿¡ï¼ŒåŠ ä¸Š wechat-trigger è¿™ä¸ªå…³é”® class*/
                        class={`btn-regular rounded-lg h-10 w-10 active:scale-90 ${isWechat ? 'wechat-trigger' : ''}`}
                    >
                        <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                    </a>
                );
            })}
        </div>

        <div id="wx-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity opacity-0 cursor-pointer">
            <div class="wx-modal-content relative bg-white dark:bg-[#1e1e1e] p-1 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300 w-[90%] max-w-[550px] cursor-default" onclick="event.stopPropagation()">
                <div class="overflow-hidden rounded-lg">
                    <img src="/assets/images/wechat-qr.png" 
                         alt="å…³æ³¨å…¬ä¼—å·" 
                         class="block w-full h-auto object-contain select-none pointer-events-none">
                </div>
            </div>
        </div>

        {umamiEnabled && (
            <hr class="my-2 border-t border-dashed border-gray-300 dark:border-gray-700" />
            <div class="text-sm text-gray-500 mt-2 text-center"
                 id="site-stats-container"
                 data-umami-base-url={umamiBaseUrl}
                 data-umami-api-key={umamiApiKey}
                 data-umami-website-id={umamiWebsiteId}
                 data-i18n-error={i18n(I18nKey.statsError)}
            >
                <Icon name="fa6-solid:eye" class="inline-block mr-1 text-gray-400 text-sm align-middle" />
                <span id="site-stats-display">ç»Ÿè®¡åŠ è½½ä¸­...</span>
            </div>
        )}
    </div>
</div>

{umamiEnabled && (
    <script>
        import "@/plugins/umami-share";
        function generateStatsText(pageViews, visits) {
            return `æµè§ˆé‡ ${pageViews} Â· è®¿é—®æ¬¡æ•° ${visits}`;
        }
        async function fetchSiteStats() {
            const container = document.getElementById('site-stats-container');
            if (!container) return;
            const umamiBaseUrl = container.dataset.umamiBaseUrl;
            const umamiApiKey = container.dataset.umamiApiKey;
            const umamiWebsiteId = container.dataset.umamiWebsiteId;
            const i18nError = container.dataset.i18nError;

            try {
                // @ts-ignore
                const stats = await window.getUmamiWebsiteStats(umamiBaseUrl, umamiApiKey, umamiWebsiteId);
                const pageViews = stats.pageviews || 0;
                const visits = stats.visits || 0;
                const displayElement = document.getElementById('site-stats-display');
                if (displayElement) {
                    displayElement.textContent = generateStatsText(pageViews, visits);
                }
            } catch (error) {
                console.error('Error fetching site stats:', error);
                const displayElement = document.getElementById('site-stats-display');
                if (displayElement) {
                    displayElement.textContent = i18nError || null;
                }
            }
        }
        fetchSiteStats();
        document.addEventListener('astro:page-load', fetchSiteStats);
    </script>
)}

<script is:inline>
    (function() {
        const MODAL_ID = 'wx-modal';
        const TRIGGER_SELECTOR = '.wechat-trigger'; 

        function initModal() {
            const modal = document.getElementById(MODAL_ID);
            
            if (!modal) {
                setTimeout(initModal, 100); 
                return;
            }
            
            // ğŸ§¹ æ¸…ç†é‡å¤çš„ Modal
            // å¦‚æœé¡µé¢å‘ç”Ÿé‡ç»˜ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ–°çš„ modal DOMï¼Œå¯¼è‡´ ID å†²çª
            // æˆ‘ä»¬ä¿ç•™ body ä¸‹çš„é‚£ä¸€ä¸ªï¼Œç§»é™¤å½“å‰ç»„ä»¶å†…æ–°ç”Ÿæˆçš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const allModals = document.querySelectorAll(`#${MODAL_ID}`);
            if (allModals.length > 1) {
                allModals.forEach(m => {
                    if (m !== modal && m.parentElement !== document.body) {
                        m.remove();
                    }
                });
            }

            // å°† modal ç§»åŠ¨åˆ° body
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }

            const content = modal.querySelector('.wx-modal-content');
            const triggers = document.querySelectorAll(TRIGGER_SELECTOR);

            if (triggers.length === 0) return;

            const openModal = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    if (content) {
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    }
                });
            };

            const closeModal = () => {
                modal.classList.add('opacity-0');
                if (content) {
                    content.classList.remove('scale-100');
                    content.classList.add('scale-95');
                }
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }, 300);
            };

            // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®š
            triggers.forEach(btn => {
                // å¦‚æœè¿™ä¸ªæŒ‰é’®å·²ç»ç»‘å®šè¿‡äº†ï¼Œç›´æ¥è·³è¿‡
                if (btn.dataset.wxBound === 'true') {
                    return;
                }

                // ç»‘å®šäº‹ä»¶
                btn.addEventListener('click', openModal);
                
                // æ‰“ä¸Šâ€œå·²ç»‘å®šâ€çš„æ ‡ç­¾
                btn.dataset.wxBound = 'true';
            });

            // ç‚¹å‡»é®ç½©å…³é—­ (åªéœ€è¦ç»‘å®šä¸€æ¬¡ï¼Œç»™ modal åŠ ä¸ªæ ‡è®°)
            if (modal.dataset.wxBound !== 'true') {
                modal.onclick = (e) => {
                    closeModal();
                };
                modal.dataset.wxBound = 'true';
            }

            // ESC å…³é—­ (Document ä¸Šçš„äº‹ä»¶éœ€è¦å°å¿ƒå¤„ç†ï¼Œå…ˆç§»é™¤å†æ·»åŠ æ˜¯å®‰å…¨çš„)
            const handleEsc = (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            };
            document.removeEventListener('keydown', handleEsc);
            document.addEventListener('keydown', handleEsc);
        }

        // ç”Ÿå‘½å‘¨æœŸ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
        document.addEventListener('astro:page-load', initModal);
        document.addEventListener('swup:contentReplaced', initModal);
    })();
</script>