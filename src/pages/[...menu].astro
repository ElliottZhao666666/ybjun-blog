---
import BackwardButton from "@components/backwardButton.astro";
import { LinkPresets } from "@constants/link-presets";
import GridLayout from "@layouts/grid.astro";
import { url } from "@utils/url";
import { Icon } from "astro-icon/components";
import { navbarConfig } from "@/config";
import { type NavbarLink } from "@/types/config";

export async function getStaticPaths() {
	return navbarConfig.links
		.filter((link) => {
			// 1. å¿…é¡»æ˜¯å¯¹è±¡ä¸”æœ‰å­é¡¹
			if (
				typeof link === "number" ||
				!link.children ||
				link.children.length === 0
			) {
				return false;
			}

			// 2. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ undefined æŠ¥é”™
			// å¦‚æœè¿™ä¸ªèœå•é¡¹æ²¡æœ‰é…ç½® urlï¼Œç›´æ¥è·³è¿‡ï¼Œä¸ç»™å®ƒç”Ÿæˆé¡µé¢
			if (!link.url) return false;

			// 3. ğŸŸ¢ é€»è¾‘ä¼˜åŒ–ï¼šä¸è¦ä¸ºâ€œçº¯æŒ‰é’®â€æˆ–â€œå¤–éƒ¨é“¾æ¥â€ç”Ÿæˆç´¢å¼•é¡µ
			// æ¯”å¦‚ "javascript:void(0)" è¿™ç§åªæ˜¯ä¸ºäº†è§¦å‘ä¸‹æ‹‰èœå•çš„ï¼Œä¸éœ€è¦ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ /javascript:void(0)/ ç½‘é¡µ
			if (
				link.url.startsWith("http") ||
				link.url.startsWith("https") ||
				link.url.startsWith("javascript:") ||
				link.url.startsWith("mailto:")
			) {
				return false;
			}

			return true;
		})
		.map((link) => {
			const navLink = link as NavbarLink;
			// æå– slugï¼Œå»æ‰å‰åçš„æ–œæ 
			const slug = navLink.url.replace(/^\/|\/$/g, "");
			return {
				params: { menu: slug },
				props: { link: navLink },
			};
		});
}

interface Props {
	link: NavbarLink;
}

const { link } = Astro.props;
const childrenLinks = link.children || [];

// å¤„ç†å­é“¾æ¥ï¼šå°†é¢„è®¾è½¬æ¢ä¸ºå¯¹è±¡
const processedLinks = childrenLinks.map((child) => {
	if (typeof child === "number") {
		return LinkPresets[child];
	}
	return child;
});

const pageTitle = link.name;
const pageDescription = link.description || "";
---

<GridLayout title={pageTitle} description={pageDescription}>
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full">
            <BackwardButton currentPath={Astro.url.pathname} />
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
                    {pageTitle}
                </h1>
                {pageDescription && (
                    <p class="text-neutral-600 dark:text-neutral-400">
                        {pageDescription}
                    </p>
                )}
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {processedLinks.map(child => {
                    // ğŸŸ¢ è‡ªåŠ¨æ£€æµ‹æ˜¯å¦ä¸ºå¤–éƒ¨é“¾æ¥
                    const isExternal = child.url.startsWith('http') || child.url.startsWith('//');
                    const href = isExternal ? child.url : url(child.url);
                    
                    return (
                        <a
                            href={href}
                            target={isExternal ? "_blank" : null}
                            class="menu-card group flex flex-col items-center justify-center p-8 rounded-xl border transition-all duration-300"
                        >
                            <div class="icon-wrapper w-16 h-16 flex items-center justify-center rounded-full mb-4 transition-all duration-300">
                                {child.icon && <Icon name={child.icon} class="text-3xl" />}
                            </div>
                            <h2 class="text-xl font-bold text-neutral-900 dark:text-neutral-100 group-hover:text-[var(--primary)] transition-colors duration-300 text-center">
                                {child.name}
                            </h2>
                            {child.description && (
                                <p class="text-sm text-neutral-600 dark:text-neutral-400 text-center mt-2 line-clamp-2">
                                    {child.description}
                                </p>
                            )}
                        </a>
                    );
                })}
            </div>
        </div>
    </div>
</GridLayout>

<style>
    .menu-card {
        cursor: pointer;
        background-color: transparent;
        border-color: var(--line-divider);
    }

    .icon-wrapper {
        background-color: color-mix(in oklch, var(--primary), transparent 85%);
        color: var(--primary);
    }

    .menu-card:hover {
        background-color: color-mix(in oklch, var(--primary), transparent 95%);
        border-color: var(--primary);
        box-shadow: 0 0 20px color-mix(in oklch, var(--primary), transparent 80%);
        translate: 0 -4px;
    }

    .menu-card:hover .icon-wrapper {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 0 15px color-mix(in oklch, var(--primary), transparent 50%);
    }
</style>